#!/bin/bash

# Script centralizado para ejecutar herramientas y utilidades
#
# Instalaci√≥n:
#   1. Copiar o crear enlace simb√≥lico: ln -s /Users/josepgarcia/Developer/Tools/tools ~/bin/tools
#   2. Dar permisos de ejecuci√≥n: chmod +x ~/bin/tools
#   3. A√±adir ~/bin al PATH (si no est√°): echo 'export PATH="$HOME/bin:$PATH"' >> ~/.zshrc
#   4. Recargar configuraci√≥n: source ~/.zshrc
#
# Uso: tools <comando> [opciones]

# Resolve the source to handle symlinks
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
TOOLS_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Colores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${YELLOW}Tools Manager${NC}"
    echo ""
    echo -e "${BLUE}USO:${NC}"
    echo "    tools <comando> [opciones]"
    echo ""
    echo -e "${BLUE}Comandos de Gesti√≥n:${NC}"
    echo -e "  ${GREEN}update${NC}               Actualizar todas las herramientas y subm√≥dulos"
    echo ""
    echo -e "${BLUE}Comandos de Seguridad:${NC}"
    echo -e "  ${GREEN}whatweb${NC}              Identificar tecnolog√≠as web"
    echo -e "  ${GREEN}domain-analyzer${NC}      Analizar dominios"
    echo -e "  ${GREEN}php-scanner${NC}          Escanear malware PHP"
    echo ""
    echo -e "${BLUE}Comandos de WordPress:${NC}"
    echo -e "  ${GREEN}wp-create${NC}            Crear nueva instalaci√≥n de WordPress"
    echo -e "  ${GREEN}wp-delete${NC}            Eliminar instalaci√≥n de WordPress"
    echo -e "  ${GREEN}wp-setup-env${NC}         Configurar entorno (carpeta + BD)"
    echo -e "  ${GREEN}wp-plugin-create${NC}     Crear estructura de nuevo plugin"
    echo -e "  ${GREEN}wp-reset-admin${NC}       Resetear usuario admin (ejecutar en carpeta WP)"
    echo ""
    echo -e "${BLUE}Comandos de Backup:${NC}"
    echo -e "  ${GREEN}mysql-backup${NC}         Respaldar base de datos MySQL"
    echo ""
    echo -e "${BLUE}Utilidades:${NC}"
    echo -e "  ${GREEN}nmap${NC}                 Ejecutar script de nmap"
    echo -e "  ${GREEN}resize-images${NC}        Redimensionar im√°genes"
}

update_tools() {
    echo "üîÑ Actualizando herramientas..."
    echo ""

    cd "$TOOLS_DIR" || exit 1

    # Actualizar repositorio principal
    echo "üì¶ Actualizando repositorio principal..."
    git pull origin main 2>/dev/null || git pull origin master 2>/dev/null || git pull
    echo ""

    # Actualizar subm√≥dulos
    echo "üîß Actualizando subm√≥dulos..."
    git submodule update --init --recursive
    git submodule update --remote --merge
    echo ""

    # Actualizar WhatWeb (si tiene Gemfile)
    if [ -f "$TOOLS_DIR/WhatWeb/Gemfile" ]; then
        echo "üíé Actualizando WhatWeb (Ruby gems)..."
        cd "$TOOLS_DIR/WhatWeb"
        bundle install 2>/dev/null || echo "‚ö†Ô∏è  Bundle no instalado, saltando..."
        cd "$TOOLS_DIR"
        echo ""
    fi

    # Actualizar domain_analyzer (si tiene requirements.txt)
    if [ -f "$TOOLS_DIR/domain_analyzer/requirements.txt" ]; then
        echo "üêç Actualizando domain_analyzer (Python packages)..."
        pip3 install -r "$TOOLS_DIR/domain_analyzer/requirements.txt" --upgrade --quiet 2>/dev/null || \
        echo "‚ö†Ô∏è  No se pudieron actualizar las dependencias de Python"
        echo ""
    fi

    # Actualizar PHP-Antimalware-Scanner (si tiene composer.json)
    if [ -f "$TOOLS_DIR/PHP-Antimalware-Scanner/composer.json" ]; then
        echo "üêò Actualizando PHP-Antimalware-Scanner (Composer)..."
        cd "$TOOLS_DIR/PHP-Antimalware-Scanner"
        composer update 2>/dev/null || echo "‚ö†Ô∏è  Composer no instalado, saltando..."
        cd "$TOOLS_DIR"
        echo ""
    fi

    echo "‚úÖ Actualizaci√≥n completada!"
    echo ""
    echo "üìä Estado de los subm√≥dulos:"
    git submodule status
}

show_menu() {
    clear
    echo -e "${BLUE}================================================${NC}"
    echo -e "${BLUE}Tools Manager - Interactive Men√∫${NC}"
    echo -e "${BLUE}================================================${NC}"
    echo -e "${YELLOW}WordPress:${NC}"
    echo -e "  ${GREEN}1)${NC} Create new WordPress site (wp-create)"
    echo -e "  ${GREEN}2)${NC} Delete WordPress site (wp-delete)"
    echo -e "  ${GREEN}3)${NC} Setup Environment (wp-setup-env)"
    echo -e "  ${GREEN}4)${NC} Create Plugin (wp-plugin-create)"
    echo -e "  ${GREEN}5)${NC} Reset Admin User (wp-reset-admin)"
    echo -e "  ${GREEN}6)${NC} DB Backup (wp-db-backup)"
    echo -e "  ${GREEN}7)${NC} DB Restore (wp-db-restore)"
    echo -e "${YELLOW}Otros:${NC}"
    echo -e "  ${GREEN}10)${NC} Update tools"
    echo -e "  ${GREEN}11)${NC} WhatWeb Scan"
    echo -e "  ${GREEN}12)${NC} Domain Analyzer"
    echo -e "  ${GREEN}13)${NC} PHP Malware Scanner"
    echo -e "  ${GREEN}14)${NC} MySQL Backup"
    echo -e "  ${GREEN}15)${NC} Nmap Scan"
    echo -e "  ${GREEN}16)${NC} Resize Images"
    echo -e "  ${RED}q)${NC} Quit"
    echo ""
    read -p "Select an option: " choice
    echo ""

    case $choice in
        1)
            read -p "Project Name: " project_name
            if [ -n "$project_name" ]; then
                "$0" wp-create "$project_name"
            else
                echo -e "${YELLOW}Cancelled: No project name provided${NC}"
            fi
            ;;
        2)
            read -p "Project Name (to delete): " project_name
            if [ -n "$project_name" ]; then
                "$0" wp-delete "$project_name"
            else
                echo -e "${YELLOW}Cancelled: No project name provided${NC}"
            fi
            ;;
        3)
            read -p "Project Name: " project_name
            if [ -n "$project_name" ]; then
                "$0" wp-setup-env "$project_name"
            else
                echo -e "${YELLOW}Cancelled: No project name provided${NC}"
            fi
            ;;
        4)
            read -p "Plugin Name: " plugin_name
            if [ -n "$plugin_name" ]; then
                "$0" wp-plugin-create "$plugin_name"
            else
                echo -e "${YELLOW}Cancelled: No plugin name provided${NC}"
            fi
            ;;
        5)
             read -p "User ID to reset [Default: 1]: " user_id
             if [ -z "$user_id" ]; then
                user_id=1
             fi
             "$0" wp-reset-admin "$user_id"
             ;;
        6)
            read -p "Optional Comment (for filename): " comment
            "$0" wp-db-backup "$comment"
            ;;
        7)
            "$0" wp-db-restore
            ;;
        10)
            "$0" update
            ;;
        11)
            read -p "Target URL: " target
            if [ -n "$target" ]; then
                "$0" whatweb "$target"
            fi
            ;;
        12)
             read -p "Domain: " domain
            if [ -n "$domain" ]; then
                "$0" domain-analyzer -d "$domain"
            fi
            ;;
        13)
            read -p "Path to scan: " scan_path
            if [ -n "$scan_path" ]; then
                "$0" php-scanner "$scan_path"
            fi
            ;;
        14)
            "$0" mysql-backup
            ;;
        15)
            "$0" nmap
            ;;
        16)
            "$0" resize-images
            ;;
        q|Q)
            echo "Bye!"
            exit 0
            ;;
        *)
            echo "Invalid option"
            ;;
    esac
}

if [ -z "$1" ]; then
    show_menu
    exit 0
fi

case "$1" in
    # Interactive Menu
    menu)
        show_menu
        ;;

    # Gesti√≥n
    update)
        update_tools
        ;;

    # Herramientas de seguridad
    whatweb)
        shift
        cd "$TOOLS_DIR/WhatWeb"
        ./whatweb "$@"
        ;;
    domain-analyzer)
        shift
        cd "$TOOLS_DIR/domain_analyzer"
        python domain_analyzer.py "$@"
        ;;
    php-scanner)
        shift
        cd "$TOOLS_DIR/PHP-Antimalware-Scanner"
        php scan.php "$@"
        ;;

    # WordPress
    wp-create)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-create.sh" "$@"
        ;;
    wp-delete)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-delete.sh" "$@"
        ;;
    wp-setup-env)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-setup-env.sh" "$@"
        ;;
    wp-plugin-create)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-plugin-create.sh" "$@"
        ;;
    wp-reset-admin)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-reset-admin.sh" "$@"
        ;;
    wp-db-backup)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-db-backup.sh" "$@"
        ;;
    wp-db-restore)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-db-restore.sh" "$@"
        ;;

    # Backup
    mysql-backup)
        shift
        "$TOOLS_DIR/scripts/utilities/mysql_backup.sh" "$@"
        ;;

    # Utilidades
    nmap)
        shift
        "$TOOLS_DIR/scripts/utilities/nmap.sh" "$@"
        ;;
    resize-images)
        shift
        "$TOOLS_DIR/scripts/utilities/redimensionar_imagenes.sh" "$@"
        ;;

    -h|--help|help)
        show_help
        ;;

    *)
        show_help
        exit 1
        ;;
esac

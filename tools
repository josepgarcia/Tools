#!/bin/bash

# Script centralizado para ejecutar herramientas y utilidades
#
# Instalaci√≥n:
#   1. Copiar o crear enlace simb√≥lico: ln -s /Users/josepgarcia/Developer/Tools/tools ~/bin/tools
#   2. Dar permisos de ejecuci√≥n: chmod +x ~/bin/tools
#   3. A√±adir ~/bin al PATH (si no est√°): echo 'export PATH="$HOME/bin:$PATH"' >> ~/.zshrc
#   4. Recargar configuraci√≥n: source ~/.zshrc
#
# Uso: tools <comando> [opciones]

TOOLS_DIR="/Users/josepgarcia/Developer/Tools"

# Colores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${YELLOW}Tools Manager${NC}"
    echo ""
    echo -e "${BLUE}USO:${NC}"
    echo "    tools <comando> [opciones]"
    echo ""
    echo -e "${BLUE}Comandos de Gesti√≥n:${NC}"
    echo -e "  ${GREEN}update${NC}               Actualizar todas las herramientas y subm√≥dulos"
    echo ""
    echo -e "${BLUE}Comandos de Seguridad:${NC}"
    echo -e "  ${GREEN}whatweb${NC}              Identificar tecnolog√≠as web"
    echo -e "  ${GREEN}domain-analyzer${NC}      Analizar dominios"
    echo -e "  ${GREEN}php-scanner${NC}          Escanear malware PHP"
    echo ""
    echo -e "${BLUE}Comandos de WordPress:${NC}"
    echo -e "  ${GREEN}wp-create${NC}            Crear nueva instalaci√≥n de WordPress"
    echo -e "  ${GREEN}wp-delete${NC}            Eliminar instalaci√≥n de WordPress"
    echo -e "  ${GREEN}wp-setup-env${NC}         Configurar entorno (carpeta + BD)"
    echo -e "  ${GREEN}wp-plugin-create${NC}     Crear estructura de nuevo plugin"
    echo ""
    echo -e "${BLUE}Comandos de Backup:${NC}"
    echo -e "  ${GREEN}mysql-backup${NC}         Respaldar base de datos MySQL"
    echo ""
    echo -e "${BLUE}Utilidades:${NC}"
    echo -e "  ${GREEN}nmap${NC}                 Ejecutar script de nmap"
    echo -e "  ${GREEN}resize-images${NC}        Redimensionar im√°genes"
}

update_tools() {
    echo "üîÑ Actualizando herramientas..."
    echo ""

    cd "$TOOLS_DIR" || exit 1

    # Actualizar repositorio principal
    echo "üì¶ Actualizando repositorio principal..."
    git pull origin main 2>/dev/null || git pull origin master 2>/dev/null || git pull
    echo ""

    # Actualizar subm√≥dulos
    echo "üîß Actualizando subm√≥dulos..."
    git submodule update --init --recursive
    git submodule update --remote --merge
    echo ""

    # Actualizar WhatWeb (si tiene Gemfile)
    if [ -f "$TOOLS_DIR/WhatWeb/Gemfile" ]; then
        echo "üíé Actualizando WhatWeb (Ruby gems)..."
        cd "$TOOLS_DIR/WhatWeb"
        bundle install 2>/dev/null || echo "‚ö†Ô∏è  Bundle no instalado, saltando..."
        cd "$TOOLS_DIR"
        echo ""
    fi

    # Actualizar domain_analyzer (si tiene requirements.txt)
    if [ -f "$TOOLS_DIR/domain_analyzer/requirements.txt" ]; then
        echo "üêç Actualizando domain_analyzer (Python packages)..."
        pip3 install -r "$TOOLS_DIR/domain_analyzer/requirements.txt" --upgrade --quiet 2>/dev/null || \
        echo "‚ö†Ô∏è  No se pudieron actualizar las dependencias de Python"
        echo ""
    fi

    # Actualizar PHP-Antimalware-Scanner (si tiene composer.json)
    if [ -f "$TOOLS_DIR/PHP-Antimalware-Scanner/composer.json" ]; then
        echo "üêò Actualizando PHP-Antimalware-Scanner (Composer)..."
        cd "$TOOLS_DIR/PHP-Antimalware-Scanner"
        composer update 2>/dev/null || echo "‚ö†Ô∏è  Composer no instalado, saltando..."
        cd "$TOOLS_DIR"
        echo ""
    fi

    echo "‚úÖ Actualizaci√≥n completada!"
    echo ""
    echo "üìä Estado de los subm√≥dulos:"
    git submodule status
}

case "$1" in
    # Gesti√≥n
    update)
        update_tools
        ;;

    # Herramientas de seguridad
    whatweb)
        shift
        cd "$TOOLS_DIR/WhatWeb"
        ./whatweb "$@"
        ;;
    domain-analyzer)
        shift
        cd "$TOOLS_DIR/domain_analyzer"
        python domain_analyzer.py "$@"
        ;;
    php-scanner)
        shift
        cd "$TOOLS_DIR/PHP-Antimalware-Scanner"
        php scan.php "$@"
        ;;

    # WordPress
    wp-create)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-create.sh" "$@"
        ;;
    wp-delete)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-delete.sh" "$@"
        ;;
    wp-setup-env)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-setup-env.sh" "$@"
        ;;
    wp-plugin-create)
        shift
        "$TOOLS_DIR/scripts/WordPress/wp-plugin-create.sh" "$@"
        ;;

    # Backup
    mysql-backup)
        shift
        "$TOOLS_DIR/scripts/backup/mysql_backup.sh" "$@"
        ;;

    # Utilidades
    nmap)
        shift
        "$TOOLS_DIR/scripts/utilities/nmap.sh" "$@"
        ;;
    resize-images)
        shift
        "$TOOLS_DIR/scripts/utilities/redimensionar_imagenes.sh" "$@"
        ;;

    -h|--help|help)
        show_help
        ;;

    *)
        show_help
        exit 1
        ;;
esac
